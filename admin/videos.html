<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Management - VideoHub Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">
    <link href="../assets/css/modal.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: white;
            border-right: 1px solid #dee2e6;
        }
        .nav-link {
            color: #495057;
            border-radius: 5px;
            margin: 2px 0;
        }
        .nav-link:hover {
            background-color: #e9ecef;
            color: #495057;
        }
        .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }
        .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .navbar {
            background-color: white;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-shield-alt me-2"></i>VideoHub Admin
            </span>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i>Admin
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item logout-btn" href="#"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="users.html">
                                <i class="fas fa-users me-2"></i>Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="videos.html">
                                <i class="fas fa-video me-2"></i>Videos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="profile.html">
                                <i class="fas fa-cog me-2"></i>Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-3">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                    <h1 class="h2">Video Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-outline-success">
                            <i class="fas fa-download me-1"></i>Export Report
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-video fa-2x text-primary"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title mb-0" id="totalVideos">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </h5>
                                        <small class="text-muted">Total Videos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-check-circle fa-2x text-success"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title mb-0" id="publishedVideos">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </h5>
                                        <small class="text-muted">Published</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-clock fa-2x text-warning"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title mb-0" id="pendingVideos">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </h5>
                                        <small class="text-muted">Pending Review</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-flag fa-2x text-danger"></i>
                                    </div>
                                    <div>
                                        <h5 class="card-title mb-0" id="flaggedVideos">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </h5>
                                        <small class="text-muted">Flagged</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Filter Videos</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Search Videos</label>
                                <input type="text" class="form-control" placeholder="Search by title or creator..." id="searchInput">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="published">Published</option>
                                    <option value="pending">Pending</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="flagged">Flagged</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Creator</label>
                                <select class="form-select" id="creatorFilter">
                                    <option value="">All Creators</option>
                                    <option value="john_creator">John Creator</option>
                                    <option value="jane_creator">Jane Creator</option>
                                    <option value="mike_creator">Mike Creator</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="categoryFilter">
                                    <option value="">All Categories</option>
                                    <option value="technology">Technology</option>
                                    <option value="education">Education</option>
                                    <option value="entertainment">Entertainment</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="dateFilter">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100 d-block" id="applyFilters">
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Videos Grid -->
                <div class="row g-4 mb-4" id="videosGrid">
                    <!-- Loading indicator -->
                    <div class="col-12 text-center" id="videosLoadingIndicator">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading videos...</span>
                        </div>
                        <p class="text-muted mt-2">Loading videos from database...</p>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="text-center py-5 d-none" id="emptyState">
                    <div class="mb-4">
                        <i class="fas fa-video fa-4x text-muted opacity-50"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Videos Found</h4>
                    <p class="text-muted mb-4">Try adjusting your filters or search criteria to find videos.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('searchInput').value=''; document.getElementById('statusFilter').value=''; applyFilters();">
                        <i class="fas fa-refresh me-2"></i>Clear Filters
                    </button>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center" id="paginationContainer">
                    <span class="text-muted" id="paginationInfo">No videos loaded</span>
                    <nav aria-label="Video pagination" id="paginationNav" style="display: none;">
                        <ul class="pagination mb-0" id="paginationList">
                            <!-- Pagination will be dynamically generated -->
                        </ul>
                    </nav>
                </div>
            </main>
        </div>
    </div>

    <!-- Video Details Modal -->
    <div class="modal fade" id="videoDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-video me-2"></i>Video Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-md-5">
                            <div class="video-thumbnail mb-3">
                                <img id="modalVideoThumbnail" src="https://via.placeholder.com/300x200/007bff/ffffff?text=Video+Preview" class="img-fluid" alt="Video Thumbnail">
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h5 id="modalVideoTitle">JavaScript Advanced Concepts</h5>
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label class="form-label text-muted">Creator</label>
                                    <p id="modalVideoCreator">John Creator</p>
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-muted">Duration</label>
                                    <p id="modalVideoDuration">45:30</p>
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-muted">Upload Date</label>
                                    <p id="modalVideoDate">2024-03-10</p>
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-muted">Views</label>
                                    <p id="modalVideoViews">1,234</p>
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-muted">Price</label>
                                    <p class="text-success" id="modalVideoPrice">$19.99</p>
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-muted">Status</label>
                                    <span class="badge bg-warning" id="modalVideoStatus">Pending</span>
                                </div>
                            </div>
                            <div>
                                <label class="form-label text-muted">Description</label>
                                <p id="modalVideoDescription">Deep dive into advanced JavaScript concepts including closures, prototypes, and async programming.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="approveVideo">
                        <i class="fas fa-check me-2"></i>Approve
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectVideo">
                        <i class="fas fa-times me-2"></i>Reject
                    </button>
                    <button type="button" class="btn btn-warning" id="flagVideo">
                        <i class="fas fa-flag me-2"></i>Flag
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div class="modal fade" id="videoPlayerModal" tabindex="-1" aria-labelledby="videoPlayerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content border-0 bg-dark">
                <div class="modal-header bg-dark text-white border-0 py-2">
                    <h5 class="modal-title fw-bold" id="videoPlayerModalLabel">
                        <i class="fas fa-play-circle text-primary me-2"></i>
                        <span id="videoTitle">Watch Video</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 d-flex align-items-center justify-content-center bg-black">
                    <div class="w-100 h-100 position-relative">
                        <div class="ratio ratio-16x9 h-100">
                            <iframe id="youtubePlayer" 
                                    src="" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                    allowfullscreen
                                    class="w-100 h-100">
                            </iframe>
                        </div>

                        <!-- Loading Overlay -->
                        <div id="playerLoading" class="position-absolute top-50 start-50 translate-middle text-white text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mb-0">Loading video player...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-dark text-white border-0 py-2">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle text-muted me-2"></i>
                            <small class="text-muted">Press ESC or click outside to close</small>
                        </div>
                        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Close Player
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Deployment Config (load first) -->
    <script src="../deployment-config.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/global-state.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth-manager.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/admin.js"></script>

    <script>
        // Initialize admin manager for videos page
        let adminManager;
        let currentPage = 1;
        let itemsPerPage = 12;
        let totalVideos = 0;
        let filteredVideos = [];
        let allVideos = [];

        document.addEventListener('DOMContentLoaded', function() {
            adminManager = new AdminManager();
            initializeVideoFilters();
            loadVideosData();
        });
        var apiUrl = window.videoHubConfig ? window.videoHubConfig.getApiUrl() : '/api';
        function initializeVideoFilters() {
            // Apply filters button
            const applyBtn = document.getElementById('applyFilters');
            if (applyBtn) applyBtn.addEventListener('click', applyFilters);
            
            // Search input with debounce
            let searchTimeout;
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyFilters, 500);
                });
            }
            
            // Filter select changes
            const statusFilter = document.getElementById('statusFilter');
            const creatorFilter = document.getElementById('creatorFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const dateFilter = document.getElementById('dateFilter');
            
            if (statusFilter) statusFilter.addEventListener('change', applyFilters);
            if (creatorFilter) creatorFilter.addEventListener('change', applyFilters);
            if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
            if (dateFilter) dateFilter.addEventListener('change', applyFilters);
        }

        async function loadVideosData() {
            try {
                // Show loading state
                const loadingElement = document.getElementById('videosLoadingIndicator');
                if (loadingElement) loadingElement.style.display = 'block';
                document.getElementById('emptyState').classList.add('d-none');
                
                // Load videos from API
                const response = await fetch(`${apiUrl}/endpoints/videos.php`);
                const result = await response.json();
                
                console.log('API Response:', result); // Debug log
                
                // Handle different response formats
                let videos = [];
                if (result.success && result.data) {
                    if (Array.isArray(result.data)) {
                        videos = result.data;
                    } else if (result.data.videos && Array.isArray(result.data.videos)) {
                        videos = result.data.videos;
                    } else {
                        videos = [];
                    }
                } else if (Array.isArray(result)) {
                    videos = result;
                } else if (result.videos && Array.isArray(result.videos)) {
                    videos = result.videos;
                } else {
                    console.warn('Unexpected API response format:', result);
                    videos = [];
                }
                
                allVideos = videos;
                filteredVideos = [...allVideos];
                totalVideos = allVideos.length;
                
                if (allVideos.length > 0) {
                    // Populate creator filter with unique creators
                    populateCreatorFilter();
                    
                    // Apply initial display
                    applyFilters();
                } else {
                    // Show empty state
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                allVideos = [];
                filteredVideos = [];
                totalVideos = 0;
                showEmptyState();
            } finally {
                const loadingElement = document.getElementById('videosLoadingIndicator');
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        function populateCreatorFilter() {
            const creatorFilter = document.getElementById('creatorFilter');
            if (!creatorFilter || !Array.isArray(allVideos)) return;
            
            const creators = [...new Set(allVideos.map(video => 
                video.creatorName || video.creator_name || video.creator
            ))].filter(Boolean);
            
            // Clear existing options except "All Creators"
            while (creatorFilter.children.length > 1) {
                creatorFilter.removeChild(creatorFilter.lastChild);
            }
            
            // Add creator options
            creators.forEach(creator => {
                const option = document.createElement('option');
                option.value = creator;
                option.textContent = creator;
                creatorFilter.appendChild(option);
            });
        }

        function applyFilters() {
            if (!Array.isArray(allVideos)) {
                console.warn('allVideos is not an array:', allVideos);
                showEmptyState();
                return;
            }
            
            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const creatorFilter = document.getElementById('creatorFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const dateFilter = document.getElementById('dateFilter')?.value || '';
            
            // Filter videos based on criteria
            filteredVideos = allVideos.filter(video => {
                if (!video) return false;
                
                const creatorName = video.creatorName || video.creator_name || video.creator || '';
                const title = video.title || '';
                
                // Search filter
                if (searchTerm && !title.toLowerCase().includes(searchTerm) && 
                    !creatorName.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Status filter
                if (statusFilter && video.status !== statusFilter) {
                    return false;
                }
                
                // Creator filter
                if (creatorFilter && creatorName !== creatorFilter) {
                    return false;
                }
                
                // Category filter
                if (categoryFilter && video.category !== categoryFilter) {
                    return false;
                }
                
                // Date filter
                if (dateFilter) {
                    const videoDate = new Date(video.uploadDate || video.upload_date || video.created_at);
                    const now = new Date();
                    let cutoffDate;
                    
                    switch (dateFilter) {
                        case 'today':
                            cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'week':
                            cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            cutoffDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                        default:
                            cutoffDate = null;
                    }
                    
                    if (cutoffDate && videoDate < cutoffDate) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Reset to first page when filters change
            currentPage = 1;
            
            // Update display
            displayVideos();
            updatePagination();
            updateVideoStats();
        }

        function displayVideos() {
            const videosGrid = document.getElementById('videosGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredVideos.length === 0) {
                videosGrid.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }
            
            emptyState.classList.add('d-none');
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const videosToShow = filteredVideos.slice(startIndex, endIndex);
            
            // Generate video cards
            const videoCards = videosToShow.map(video => generateVideoCard(video)).join('');
            videosGrid.innerHTML = videoCards;
            
            // Add event listeners to video cards
            addVideoCardListeners();
        }

        function generateVideoCard(video) {
            const statusClass = getStatusClass(video.status);
            // Use a more reliable thumbnail fallback strategy
            let thumbnail = video.thumbnail;
            if (!thumbnail || thumbnail.includes('placeholder')) {
                thumbnail = video.youtube_id ? 
                    `https://img.youtube.com/vi/${video.youtube_id}/mqdefault.jpg` :
                    'https://via.placeholder.com/300x169/4f46e5/ffffff?text=No+Image';
            }
            const creatorName = video.creatorName || video.creator_name || video.creator || 'Unknown';
            const uploadDate = video.uploadDate || video.upload_date || video.created_at;
            
            // Generate action buttons based on current status
            let actionButtons = '';
            const currentStatus = video.status || 'pending';
            
            if (currentStatus === 'published') {
                // If published, show only reject and flag buttons
                actionButtons = `
                    <button class="btn btn-danger btn-sm me-1 reject-video" data-video-id="${video.id}" title="Reject">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="btn btn-warning btn-sm flag-video" data-video-id="${video.id}" title="Flag">
                        <i class="fas fa-flag"></i> Flag
                    </button>
                `;
            } else if (currentStatus === 'rejected') {
                // If rejected, show only approve and flag buttons
                actionButtons = `
                    <button class="btn btn-success btn-sm me-1 approve-video" data-video-id="${video.id}" title="Approve">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-warning btn-sm flag-video" data-video-id="${video.id}" title="Flag">
                        <i class="fas fa-flag"></i> Flag
                    </button>
                `;
            } else if (currentStatus === 'flagged') {
                // If flagged, show approve and reject buttons
                actionButtons = `
                    <button class="btn btn-success btn-sm me-1 approve-video" data-video-id="${video.id}" title="Approve">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-danger btn-sm reject-video" data-video-id="${video.id}" title="Reject">
                        <i class="fas fa-times"></i> Reject
                    </button>
                `;
            } else {
                // For pending or other statuses, show all buttons
                actionButtons = `
                    <button class="btn btn-success btn-sm me-1 approve-video" data-video-id="${video.id}" title="Approve">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-danger btn-sm me-1 reject-video" data-video-id="${video.id}" title="Reject">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="btn btn-warning btn-sm flag-video" data-video-id="${video.id}" title="Flag">
                        <i class="fas fa-flag"></i> Flag
                    </button>
                `;
            }
            
            return `
                <div class="col-lg-4 col-md-6">
                    <div class="card h-100 video-card" data-video-id="${video.id}" data-status="${currentStatus}">
                        <div class="position-relative">
                            <img src="${thumbnail}" class="card-img-top" alt="${video.title}" style="height: 200px; object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x169/4f46e5/ffffff?text=No+Image';">
                            <span class="badge ${statusClass} position-absolute top-0 end-0 m-2" id="status-badge-${video.id}">${currentStatus}</span>
                            <div class="video-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                                <button class="btn btn-primary btn-sm me-2 play-video" data-video-id="${video.id}">
                                    <i class="fas fa-play"></i> Play
                                </button>
                                <button class="btn btn-outline-light btn-sm view-details" data-video-id="${video.id}">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${video.title}</h6>
                            <p class="card-text text-muted small mb-2">
                                <i class="fas fa-user me-1"></i>${creatorName}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-eye me-1"></i>${video.views || 0} views
                                </small>
                                <small class="text-success fw-bold">
                                    $${video.price || '0.00'}
                                </small>
                            </div>
                            <div class="mt-2" id="action-buttons-${video.id}">
                                ${actionButtons}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'published': return 'bg-success';
                case 'pending': return 'bg-warning';
                case 'rejected': return 'bg-danger';
                case 'flagged': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function addVideoCardListeners() {
            // Add hover effect to video cards
            document.querySelectorAll('.video-card').forEach(card => {
                const overlay = card.querySelector('.video-overlay');
                card.addEventListener('mouseenter', () => overlay.style.opacity = '1');
                card.addEventListener('mouseleave', () => overlay.style.opacity = '0');
            });
            
            // Play video buttons
            document.querySelectorAll('.play-video').forEach(btn => {
                btn.addEventListener('click', function() {
                    const videoId = this.getAttribute('data-video-id');
                    playVideo(videoId);
                });
            });
            
            // View details buttons
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', function() {
                    const videoId = this.getAttribute('data-video-id');
                    showVideoDetails(videoId);
                });
            });
            
            // Action buttons with confirmation modals
            document.querySelectorAll('.approve-video').forEach(btn => {
                btn.addEventListener('click', function() {
                    const videoId = this.getAttribute('data-video-id');
                    showActionConfirmModal('approve', videoId);
                });
            });
            
            document.querySelectorAll('.reject-video').forEach(btn => {
                btn.addEventListener('click', function() {
                    const videoId = this.getAttribute('data-video-id');
                    showActionConfirmModal('reject', videoId);
                });
            });
            
            document.querySelectorAll('.flag-video').forEach(btn => {
                btn.addEventListener('click', function() {
                    const videoId = this.getAttribute('data-video-id');
                    showActionConfirmModal('flag', videoId);
                });
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredVideos.length / itemsPerPage);
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationNav = document.getElementById('paginationNav');
            const paginationList = document.getElementById('paginationList');
            
            if (totalPages <= 1) {
                paginationNav.style.display = 'none';
                const startItem = filteredVideos.length > 0 ? 1 : 0;
                paginationInfo.textContent = `Showing ${startItem}-${filteredVideos.length} of ${filteredVideos.length} videos`;
                return;
            }
            
            paginationNav.style.display = 'block';
            
            // Update pagination info
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredVideos.length);
            paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${filteredVideos.length} videos`;
            
            // Generate pagination links
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                </li>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                </li>
            `;
            
            paginationList.innerHTML = paginationHTML;
            
            // Add click listeners to pagination links
            paginationList.querySelectorAll('a[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page >= 1 && page <= totalPages && page !== currentPage) {
                        currentPage = page;
                        displayVideos();
                        updatePagination();
                        // Scroll to top of videos section
                        document.getElementById('videosGrid').scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }

        function updateVideoStats() {
            if (!Array.isArray(filteredVideos)) return;
            
            // Update the stats cards with current filtered data
            const published = filteredVideos.filter(v => v && v.status === 'published').length;
            const pending = filteredVideos.filter(v => v && v.status === 'pending').length;
            const flagged = filteredVideos.filter(v => v && v.status === 'flagged').length;
            
            const totalElement = document.getElementById('totalVideos');
            const publishedElement = document.getElementById('publishedVideos');
            const pendingElement = document.getElementById('pendingVideos');
            const flaggedElement = document.getElementById('flaggedVideos');
            
            if (totalElement) totalElement.textContent = filteredVideos.length;
            if (publishedElement) publishedElement.textContent = published;
            if (pendingElement) pendingElement.textContent = pending;
            if (flaggedElement) flaggedElement.textContent = flagged;
        }

        function showEmptyState() {
            const videosGrid = document.getElementById('videosGrid');
            const emptyState = document.getElementById('emptyState');
            const paginationNav = document.getElementById('paginationNav');
            const paginationInfo = document.getElementById('paginationInfo');
            
            if (videosGrid) videosGrid.innerHTML = '';
            if (emptyState) emptyState.classList.remove('d-none');
            if (paginationNav) paginationNav.style.display = 'none';
            if (paginationInfo) paginationInfo.textContent = 'No videos found';
        }

        function showActionConfirmModal(action, videoId) {
            const video = allVideos.find(v => v.id == videoId);
            if (!video) return;
            
            const actionTexts = {
                approve: { title: 'Approve Video', message: 'approve', class: 'success' },
                reject: { title: 'Reject Video', message: 'reject', class: 'danger' },
                flag: { title: 'Flag Video', message: 'flag', class: 'warning' }
            };
            
            const actionData = actionTexts[action];
            if (!actionData) return;
            
            // Create confirmation modal
            let modal = document.getElementById('actionConfirmModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'actionConfirmModal';
                modal.setAttribute('tabindex', '-1');
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="actionModalTitle">Confirm Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p id="actionModalMessage">Are you sure you want to perform this action?</p>
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title" id="actionModalVideoTitle">Video Title</h6>
                                        <p class="card-text text-muted" id="actionModalVideoCreator">Creator</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn" id="confirmActionBtn">Confirm</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Update modal content
            document.getElementById('actionModalTitle').textContent = actionData.title;
            document.getElementById('actionModalMessage').textContent = `Are you sure you want to ${actionData.message} this video?`;
            document.getElementById('actionModalVideoTitle').textContent = video.title;
            document.getElementById('actionModalVideoCreator').textContent = `By ${video.creator_name || video.creator || 'Unknown'}`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.className = `btn btn-${actionData.class}`;
            confirmBtn.textContent = `${actionData.title.split(' ')[0]}`;
            
            // Set up confirm button action
            confirmBtn.onclick = function() {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                bootstrapModal.hide();
                performVideoAction(action, videoId);
            };
            
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }

        async function performVideoAction(action, videoId) {
            try {
                // Map action to status
                const statusMap = {
                    approve: 'published',
                    reject: 'rejected', 
                    flag: 'flagged'
                };
                
                const status = statusMap[action];
                if (!status) {
                    throw new Error('Invalid action');
                }
                
                const response = await fetch(`${apiUrl}/endpoints/videos.php/${videoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: videoId,
                        status: status
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update video in both local arrays
                    const updateVideoStatus = (videoArray) => {
                        const video = videoArray.find(v => v.id == videoId);
                        if (video) {
                            video.status = status;
                            return video;
                        }
                        return null;
                    };
                    
                    const updatedVideo = updateVideoStatus(allVideos);
                    updateVideoStatus(filteredVideos);
                    
                    // Update the specific video card in the DOM without full refresh
                    if (updatedVideo) {
                        updateVideoCardInDOM(updatedVideo);
                    }
                    
                    // Update stats
                    updateVideoStats();
                    
                    // Show success message
                    if (window.commonUtils) {
                        window.commonUtils.showToast(`Video ${action}d successfully!`, 'success');
                    } else {
                        // Fallback alert
                        alert(`Video ${action}d successfully!`);
                    }
                } else {
                    throw new Error(result.message || 'Action failed');
                }
            } catch (error) {
                console.error(`Error ${action}ing video:`, error);
                if (window.commonUtils) {
                    window.commonUtils.showToast(`Error ${action}ing video: ${error.message}`, 'danger');
                } else {
                    // Fallback alert
                    alert(`Error ${action}ing video: ${error.message}`);
                }
            }
        }

        function updateVideoCardInDOM(video) {
            const videoCard = document.querySelector(`[data-video-id="${video.id}"]`);
            if (!videoCard) return;
            
            // Define currentStatus at the function level
            const currentStatus = video.status || 'pending';
            
            // Update status badge
            const statusBadge = document.getElementById(`status-badge-${video.id}`);
            if (statusBadge) {
                const statusClass = getStatusClass(video.status);
                statusBadge.className = `badge ${statusClass} position-absolute top-0 end-0 m-2`;
                statusBadge.textContent = video.status || 'unknown';
            }
            
            // Update action buttons
            const actionButtonsContainer = document.getElementById(`action-buttons-${video.id}`);
            if (actionButtonsContainer) {
                let actionButtons = '';
                
                if (currentStatus === 'published') {
                    actionButtons = `
                        <button class="btn btn-danger btn-sm me-1 reject-video" data-video-id="${video.id}" title="Reject">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="btn btn-warning btn-sm flag-video" data-video-id="${video.id}" title="Flag">
                            <i class="fas fa-flag"></i> Flag
                        </button>
                    `;
                } else if (currentStatus === 'rejected') {
                    actionButtons = `
                        <button class="btn btn-success btn-sm me-1 approve-video" data-video-id="${video.id}" title="Approve">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-warning btn-sm flag-video" data-video-id="${video.id}" title="Flag">
                            <i class="fas fa-flag"></i> Flag
                        </button>
                    `;
                } else if (currentStatus === 'flagged') {
                    actionButtons = `
                        <button class="btn btn-success btn-sm me-1 approve-video" data-video-id="${video.id}" title="Approve">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-sm reject-video" data-video-id="${video.id}" title="Reject">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button class="btn btn-success btn-sm me-1 approve-video" data-video-id="${video.id}" title="Approve">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-sm me-1 reject-video" data-video-id="${video.id}" title="Reject">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="btn btn-warning btn-sm flag-video" data-video-id="${video.id}" title="Flag">
                            <i class="fas fa-flag"></i> Flag
                        </button>
                    `;
                }
                
                actionButtonsContainer.innerHTML = actionButtons;
                
                // Re-attach event listeners to new buttons
                addVideoCardListeners();
            }
            
            // Update the data-status attribute on the card
            videoCard.setAttribute('data-status', currentStatus);
        }

        function playVideo(videoId) {
            const video = allVideos.find(v => v.id == videoId);
            if (!video || !video.youtube_id) return;
            
            const modal = document.getElementById('videoPlayerModal');
            const iframe = document.getElementById('youtubePlayer');
            const title = document.getElementById('videoTitle');
            
            title.textContent = video.title;
            iframe.src = `https://www.youtube.com/embed/${video.youtube_id}?autoplay=1`;
            
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Clean up when modal is hidden
            modal.addEventListener('hidden.bs.modal', function() {
                iframe.src = '';
            });
        }

        function showVideoDetails(videoId) {
            const video = allVideos.find(v => v.id == videoId);
            if (!video) return;
            
            const modal = document.getElementById('videoDetailsModal');
            if (!modal) {
                console.warn('Video details modal not found');
                return;
            }
            
            const creatorName = video.creatorName || video.creator_name || video.creator || 'Unknown';
            const uploadDate = video.uploadDate || video.upload_date || video.created_at;
            
            // Populate modal with video details - check if elements exist
            const modalTitle = document.getElementById('modalVideoTitle');
            const modalCreator = document.getElementById('modalVideoCreator');
            const modalDuration = document.getElementById('modalVideoDuration');
            const modalDate = document.getElementById('modalVideoDate');
            const modalViews = document.getElementById('modalVideoViews');
            const modalPrice = document.getElementById('modalVideoPrice');
            const modalDescription = document.getElementById('modalVideoDescription');
            const statusElement = document.getElementById('modalVideoStatus');
            const thumbnail = document.getElementById('modalVideoThumbnail');
            
            if (modalTitle) modalTitle.textContent = video.title;
            if (modalCreator) modalCreator.textContent = creatorName;
            if (modalDuration) modalDuration.textContent = video.duration || 'Unknown';
            if (modalDate) modalDate.textContent = uploadDate ? new Date(uploadDate).toLocaleDateString() : 'Unknown';
            if (modalViews) modalViews.textContent = (video.views || 0).toLocaleString();
            if (modalPrice) modalPrice.textContent = `$${video.price || '0.00'}`;
            if (modalDescription) modalDescription.textContent = video.description || 'No description available';
            
            if (statusElement) {
                statusElement.textContent = video.status || 'unknown';
                statusElement.className = `badge ${getStatusClass(video.status)}`;
            }
            
            if (thumbnail) {
                let thumbnailSrc = video.thumbnail;
                if (!thumbnailSrc || thumbnailSrc.includes('placeholder')) {
                    thumbnailSrc = video.youtube_id ? 
                        `https://img.youtube.com/vi/${video.youtube_id}/mqdefault.jpg` :
                        'https://via.placeholder.com/300x169/4f46e5/ffffff?text=No+Image';
                }
                thumbnail.src = thumbnailSrc;
                thumbnail.onerror = function() {
                    this.onerror = null;
                    this.src = 'https://via.placeholder.com/300x169/4f46e5/ffffff?text=No+Image';
                };
            }
            
            // Set up action buttons
            document.getElementById('approveVideo').onclick = () => {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                bootstrapModal.hide();
                showActionConfirmModal('approve', videoId);
            };
            
            document.getElementById('rejectVideo').onclick = () => {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                bootstrapModal.hide();
                showActionConfirmModal('reject', videoId);
            };
            
            document.getElementById('flagVideo').onclick = () => {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                bootstrapModal.hide();
                showActionConfirmModal('flag', videoId);
            };
            
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }

        // Watch video function for admin panel
        window.watchVideo = function(youtubeId, title) {
            if (!youtubeId) {
                alert('Video not available for playback - missing YouTube ID');
                return;
            }

            // Set modal title
            document.getElementById('videoTitle').textContent = title || 'Watch Video';

            // Set YouTube iframe source
            const iframe = document.getElementById('youtubePlayer');
            const loading = document.getElementById('playerLoading');

            // Show loading
            if (loading) loading.style.display = 'block';

            iframe.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1&controls=1&modestbranding=1&rel=0`;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('videoPlayerModal'));
            modal.show();

            // Hide loading after iframe loads
            iframe.onload = function() {
                if (loading) loading.style.display = 'none';
            };

            // Clean up when modal is closed
            document.getElementById('videoPlayerModal').addEventListener('hidden.bs.modal', function () {
                iframe.src = '';
                if (loading) loading.style.display = 'block';
            });
        };
    </script>
</body>
</html>