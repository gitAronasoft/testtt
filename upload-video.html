
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Video - VideoHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="bg-light">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <nav class="col-md-2 d-md-block bg-white sidebar collapse" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="mb-4 text-center">
                        <h4 class="text-primary">VideoHub</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="goToDashboard()">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="upload-video.html">
                                <i class="fas fa-upload me-2"></i>Upload Video
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4">
                <div class="container-fluid p-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2><i class="fas fa-upload me-2"></i>Upload Video</h2>
                                <button class="btn btn-outline-secondary" onclick="goToDashboard()">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-transparent border-0 pb-0">
                                    <h5 class="card-title">Video Details</h5>
                                    <p class="text-muted small">Fill in the information below to upload your video</p>
                                </div>
                                <div class="card-body">
                                    <form id="uploadForm">
                                        <div class="mb-3">
                                            <label for="title" class="form-label">Video Title *</label>
                                            <input type="text" class="form-control" id="title" name="title" required>
                                            <div class="invalid-feedback" id="titleError"></div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="description" class="form-label">Description *</label>
                                            <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                                            <div class="invalid-feedback" id="descriptionError"></div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="category" class="form-label">Category</label>
                                                    <select class="form-select" id="category" name="category">
                                                        <option value="entertainment">Entertainment</option>
                                                        <option value="education">Education</option>
                                                        <option value="technology">Technology</option>
                                                        <option value="sports">Sports</option>
                                                        <option value="music">Music</option>
                                                        <option value="gaming">Gaming</option>
                                                        <option value="other">Other</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="price" class="form-label">Price ($)</label>
                                                    <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" value="0">
                                                    <div class="form-text">Set to 0 for free videos</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label for="youtubeId" class="form-label">YouTube Video ID (Optional)</label>
                                            <input type="text" class="form-control" id="youtubeId" name="youtubeId" placeholder="e.g., dQw4w9WgXcQ">
                                            <div class="form-text">If you have a YouTube video, enter its ID to embed it</div>
                                        </div>

                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                                <i class="fas fa-undo me-2"></i>Reset
                                            </button>
                                            <button type="submit" class="btn btn-primary" id="submitButton">
                                                <span id="submitText">
                                                    <i class="fas fa-upload me-2"></i>Upload Video
                                                </span>
                                                <span id="submitLoading" class="d-none">
                                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                                    Uploading...
                                                </span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="components/ui/Notification.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupForm();
        });

        async function checkAuthentication() {
            try {
                const response = await fetch('/api/auth.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_user' })
                });
                
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    
                    // Check if user has permission to upload
                    if (!['admin', 'editor', 'creator'].includes(currentUser.role)) {
                        showNotification('You do not have permission to access this page', 'error');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        return;
                    }
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = 'login.html';
            }
        }

        function setupForm() {
            const form = document.getElementById('uploadForm');
            form.addEventListener('submit', handleUpload);
        }

        async function handleUpload(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const price = parseFloat(document.getElementById('price').value) || 0;
            const youtubeId = document.getElementById('youtubeId').value.trim();

            // Validation
            if (!title || !description) {
                showNotification('Title and description are required', 'error');
                return;
            }

            if (price < 0) {
                showNotification('Price cannot be negative', 'error');
                return;
            }

            setLoadingState(true);

            try {
                const uploadData = {
                    title: title,
                    description: description,
                    category: category,
                    price: price,
                    file_path: '', // For now, we're not handling file uploads
                };

                if (youtubeId) {
                    uploadData.youtube_id = youtubeId;
                }

                const response = await fetch('/api/videos.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(uploadData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Video uploaded successfully!', 'success');
                    resetForm();
                    
                    // Redirect to dashboard after success
                    setTimeout(() => {
                        goToDashboard();
                    }, 2000);
                } else {
                    showNotification('Upload failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Upload failed:', error);
                showNotification('Upload failed. Please try again.', 'error');
            } finally {
                setLoadingState(false);
            }
        }

        function setLoadingState(loading) {
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            submitButton.disabled = loading;
            
            if (loading) {
                submitText.classList.add('d-none');
                submitLoading.classList.remove('d-none');
            } else {
                submitText.classList.remove('d-none');
                submitLoading.classList.add('d-none');
            }
        }

        function resetForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('price').value = '0';
        }

        function goToDashboard() {
            if (!currentUser) return;
            
            let dashboardUrl = '';
            switch(currentUser.role) {
                case 'admin':
                    dashboardUrl = 'admin-dashboard.html';
                    break;
                case 'editor':
                case 'creator':
                    dashboardUrl = 'creator-dashboard.html';
                    break;
                case 'viewer':
                    dashboardUrl = 'viewer-dashboard.html';
                    break;
                default:
                    dashboardUrl = 'login.html';
            }
            
            window.location.href = dashboardUrl;
        }

        async function logout() {
            try {
                localStorage.removeItem('currentUser');
                
                await fetch('/api/auth.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'logout' })
                });

                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = 'login.html';
            }
        }

        function showNotification(message, type = 'info') {
            if (typeof Notification !== 'undefined' && Notification.show) {
                Notification.show(message, type);
            } else {
                // Fallback to alert
                alert(message);
            }
        }
    </script>
</body>
</html>
